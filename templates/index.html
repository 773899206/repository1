<!DOCTYPE html>
 <html>   
 	<head>     
	 	<title>Simple Map</title>     
	 	<meta name="viewport"content="initial-scale=1.0">     
	 	<meta charset="utf-8">
	 	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA0KRtOnUdHBGVMC4uubHn-5EhGnWXEAB8&callback=initMap">
		</script>
	 	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
	 	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script> 
	 	
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	 	<script type=text/javascript> $SCRIPT_ROOT = {{ request.script_root|tojson|safe }}; </script> 
	 	<style> 
		 	     
		 	#map {         
		 		height: 100%;      
			} 
			/* Optional: Makes the sample page fill the window. */      
			html, body {         
				height: 100%;         
				margin: 0;         
				padding: 0;       
			}     
		</style>   
	</head>   
	<body>     
		<div id="map"></div>  
	
	     
		<script>
			google.charts.load("current", {packages:['corechart']});
		
			var map; 
			function initMap() {         
				map = new google.maps.Map(document.getElementById('map'), {           
					center: {lat: 53.34972, lng: -6.26028},           
					zoom: 13.5       
				}); 
			get_stations();	
			} 
			
			function get_stations() {
				var jqxhr = $.getJSON($SCRIPT_ROOT+ "/stations", function(data){	
					var stations = data.stations;
					
					console.log('stations',stations);
					
					_.forEach(stations, function(station) {
					
						var marker =new google.maps.Marker({
						position: {
							lat: station.position_lat,
							lng: station.position_lng
						},
						map:map,
						title: station.name,
						station_number:station.number
						});
						
						contentString = '<div id="content"><h1>' + station.name + '</h1></div>'+ '<div id="station_availability"></div>';
                        
						google.maps.event.addListener(marker,'click',function(){
						
						  drawInfoWindowChart(marker);
    					
						
						});
					})
				})
				.fail(function() {
					console.log("error");
				})
			}
			
			function drawInfoWindowChart(marker) {
                var jqxhr = $.getJSON($SCRIPT_ROOT + "/occupancy/" + marker.station_number, function(data) {
                    data = JSON.parse(data.data);
                    console.log('data', data);
                    var node = document.createElement('div'),
                    infowindow = new google.maps.InfoWindow(),
                        
                    chart = new google.visualization.ColumnChart(node);

                    var chart_data = new google.visualization.DataTable();
                   
                    chart_data.addColumn('date', 'Time of Day');
                    chart_data.addColumn('number', '#');
                    _.forEach(data, function(row){
                        chart_data.addRow([new Date(row[0]), row[1]]);
                        
                        })
                     var today = new Date();
                     var start=new Date();
                     start.setDate(today.getDate()-14);
                    
                     var options = {
                        title: "Availability of "+marker.title,
                        width: 450,
                        height: 200,
                        hAxis:{
                            title:'Date',
                            viewWindow: {
                                    min: start,
                                    max: today
                                  },
                            gridlines:{
                                units:{
                                    days:{format:['MMM dd']}
                                }
                            },
                            minorGridlines:{
                                count:0
                            }   
                        },
                        vAxis: {
                            format: 'decimal',
                            direction:1,
                            title: '#',
                            gridlines:{
                                count:-1
                            }
                        }
                     };
                    chart.draw(chart_data,options);
                    infowindow.setContent(node);
                    infowindow.open(marker.getMap(), marker);
                }).fail(function() {
                    console.log( "error" );
                })
			}
			
			
			   
		</script>     
	 	
		

	</body> 
</html>